networks:
  local-network:
    name: pandoks-net
    driver: bridge

services:
  s3:
    image: localstack/localstack
    container_name: s3
    restart: always
    ports:
      - 4566:4566
    environment:
      - SERVICES=s3
      - AWS_DEFAULT_REGION=us-west-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=testsecret
      - BACKUP_BUCKET=database
      - PERSISTENCE=1
      - DATA_DIR=/var/lib/localstack/data
    networks:
      - local-network
    volumes:
      - ./data/localstack:/var/lib/localstack
    entrypoint:
      - sh
      - -c
      - |
        mkdir -p /etc/localstack/init/ready.d
        cat > /etc/localstack/init/ready.d/s3.sh << 'EOF'
        #!/bin/sh
        awslocal s3 mb s3://$$BACKUP_BUCKET || true
        EOF
        chmod +x /etc/localstack/init/ready.d/s3.sh
        exec docker-entrypoint.sh
