#cloud-config
# env variables:
# SSH_HOSTNAME
# ACCOUNT_ID
# TUNNEL_SECRET
# TUNNEL_ID
package_update: true
package_upgrade: true
ssh_pwauth: false
disable_root: true

users:
  - name: pandoks
    gecos: 'Admin User'
    groups: [sudo]
    sudo: 'ALL=(ALL) NOPASSWD:ALL'
    shell: /bin/bash
    ssh_authorized_keys:
      - 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE4hEZkhSO2AZfIkjVrsR9nveSclN5sO9a5RW5vDUfPJ pandoks'

packages:
  - curl
  - ca-certificates
  - jq
  - unzip

write_files:
  - path: /etc/cloudflared/CREDS.json
    owner: root:root
    permissions: '0600'
    content: |
      { "AccountTag": "${ACCOUNT_ID}", "TunnelSecret": "${TUNNEL_SECRET}", "TunnelID": "${TUNNEL_ID}" }
  - path: /etc/cloudflared/config.yml
    owner: root:root
    permissions: '0644'
    content: |
      tunnel: ${TUNNEL_ID}
      credentials-file: /etc/cloudflared/CREDS.json
      ingress:
        - hostname: ${SSH_HOSTNAME}
          service: ssh://localhost:22
        - service: http_status:404
  - path: /etc/ssh/sshd_config.d/99-hardening.conf
    owner: root:root
    permissions: '0644'
    content: |
      PasswordAuthentication no
      PubkeyAuthentication yes
      KbdInteractiveAuthentication no
      PermitRootLogin no
      ChallengeResponseAuthentication no
      UsePAM yes
      AllowUsers pandoks

runcmd:
  - install -m 0755 -d /usr/share/keyrings
  - curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
  - echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/ $(. /etc/os-release && echo $VERSION_CODENAME) main" | tee /etc/apt/sources.list.d/cloudflare-main.list
  - apt-get update
  - apt-get install -y cloudflared
  - mkdir -p /etc/cloudflared && chown root:root /etc/cloudflared && chmod 0755 /etc/cloudflared
  - systemctl restart ssh || true
  - cloudflared --config /etc/cloudflared/config.yml service install || true
  - systemctl enable cloudflared && systemctl restart cloudflared
